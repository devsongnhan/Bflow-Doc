# Manual Journal Entry - Design Specification

**Document Version:** 1.0
**Created:** 2024-10-31
**Module:** Core Accounting
**Feature Code:** CORE-JE-001
**Related Database Design:** `Core_Accounting_Database_Design_v2.md` Section 2.3

---

## Table of Contents

1. [Feature Overview](#1-feature-overview)
2. [Feature Requirements](#2-feature-requirements)
3. [UI Components & Screens](#3-ui-components--screens)
4. [User Workflows](#4-user-workflows)
5. [Business Rules](#5-business-rules)
6. [Validation Rules](#6-validation-rules)
7. [Data Model Integration](#7-data-model-integration)
8. [Dimension Split Integration](#8-dimension-split-integration)
9. [Test Scenarios](#9-test-scenarios)
10. [Technical Notes](#10-technical-notes)

---

## 1. Feature Overview

### 1.1 Purpose

**Manual Journal Entry** is the CORE feature of the accounting module that allows users to manually create journal entries for transactions that cannot be auto-generated by the system. This is THE feature where all accounting capabilities converge:

- **Chart of Accounts integration**
- **Flexible Dimensions** (account-specific dimension rules)
- **Dimension Split Templates** usage
- **Debit/Credit balance validation**
- **Multi-currency support** (future)
- **DRAFT → POSTED workflow**

### 1.2 Business Context

**Use Cases:**
- **Period-end adjustments**: Accruals, deferrals, reclassifications
- **Depreciation entries**: Manual depreciation calculation results
- **Cost allocations**: Allocating shared costs across departments/projects
- **Error corrections**: Fixing posting errors from auto-generated entries
- **Opening balances**: Initial setup of account balances (special case)

**Target Users:**
- **Accountant**: Primary user - creates and posts journal entries
- **Finance Manager**: Reviews and approves complex journal entries
- **System Admin**: Creates opening balance entries

### 1.3 Key Features

| Feature | Description |
|---------|-------------|
| **Account Selection** | Searchable dropdown from Chart of Accounts |
| **Flexible Dimensions** | Each line can have different dimensions based on account rules |
| **Dimension Split** | Split a single line across multiple dimension values using templates |
| **Debit/Credit Balance** | Real-time validation that total_debit = total_credit |
| **Line Management** | Add/remove lines dynamically |
| **DRAFT/POSTED Workflow** | Save as draft, post to finalize |
| **Auto-numbering** | System generates journal numbers (JE-YYYY-####) |
| **Period Control** | Posting restricted to open periods |

---

## 2. Feature Requirements

### 2.1 Functional Requirements

| FR Code | Requirement | Priority |
|---------|-------------|----------|
| **FR-JE-001** | System shall allow users to create manual journal entries with header and lines | MUST |
| **FR-JE-002** | System shall auto-generate journal numbers with format `JE-YYYY-####` | MUST |
| **FR-JE-003** | System shall enforce balanced entries (total_debit = total_credit) before posting | MUST |
| **FR-JE-004** | System shall allow users to save journal entries as DRAFT without balance validation | MUST |
| **FR-JE-005** | System shall validate each line has either debit OR credit amount (not both) | MUST |
| **FR-JE-006** | System shall allow users to select accounts from Chart of Accounts with search | MUST |
| **FR-JE-007** | System shall display applicable dimensions based on account-dimension rules | MUST |
| **FR-JE-008** | System shall allow users to split dimension values using split templates | MUST |
| **FR-JE-009** | System shall prevent posting to closed periods | MUST |
| **FR-JE-010** | System shall create journal_line_dimensions records for each dimension value | MUST |
| **FR-JE-011** | System shall expand split lines into multiple journal_lines when posting | MUST |
| **FR-JE-012** | System shall calculate line amounts from split percentages (amount × percentage) | MUST |
| **FR-JE-013** | System shall prevent editing/deleting posted journal entries | MUST |
| **FR-JE-014** | System shall allow reversal of posted entries (creates new entry with opposite signs) | SHOULD |
| **FR-JE-015** | System shall support multi-currency entries (future enhancement) | COULD |

### 2.2 Non-Functional Requirements

| NFR Code | Requirement | Target |
|----------|-------------|--------|
| **NFR-JE-001** | Page load time | < 2 seconds |
| **NFR-JE-002** | Journal posting transaction | < 3 seconds |
| **NFR-JE-003** | Account search response | < 500ms |
| **NFR-JE-004** | Support journal entries with up to 100 lines | No performance degradation |
| **NFR-JE-005** | Concurrent users creating journal entries | 20+ users |

---

## 3. UI Components & Screens

### 3.1 Main Screen: Manual Journal Entry Form

**Location:** `html-prototypes/1_manual-journal-entry.html`

**Layout Structure:**

```
┌─────────────────────────────────────────────────────────────┐
│  TOP HEADER                                                  │
│  📒 Manual Journal Entry    [Save Draft] [Post] [Close]    │
├──────────┬──────────────────────────────────────────────────┤
│          │  MAIN CONTENT AREA                               │
│ SIDEBAR  │                                                   │
│          │  📒 Manual Journal Entry [DRAFT]                 │
│          │                                                   │
│          │  ┌─ Journal Header ──────────────────────────┐  │
│          │  │ Journal Number: JE-2024-0001 (auto)       │  │
│          │  │ Entry Date: [date] *                       │  │
│          │  │ Posting Date: [date]                       │  │
│          │  │ Period: [dropdown] *                       │  │
│          │  │ Description: [textarea] *                  │  │
│          │  └────────────────────────────────────────────┘  │
│          │                                                   │
│          │  ┌─ Journal Lines ───────────────────────────┐  │
│          │  │ [+ Add Line]                              │  │
│          │  │                                           │  │
│          │  │ Table:                                    │  │
│          │  │ # | Account | Desc | Debit | Credit |    │  │
│          │  │   Dimensions | Actions                    │  │
│          │  │ ─────────────────────────────────────────│  │
│          │  │ 1 | 6271    | ... | 5,000,000 | - |      │  │
│          │  │   Cost Center: Production                 │  │
│          │  │   [Split] [Delete]                        │  │
│          │  │ 2 | 2141    | ... | - | 5,000,000 |      │  │
│          │  │   Asset Type: Buildings                   │  │
│          │  │   [Split] [Delete]                        │  │
│          │  └────────────────────────────────────────────┘  │
│          │                                                   │
│          │  ┌─ Totals & Balance ────────────────────────┐  │
│          │  │ Total Debit: 5,000,000                    │  │
│          │  │ Total Credit: 5,000,000                   │  │
│          │  │ Difference: 0 ✅                          │  │
│          │  │ ✅ Journal is balanced                    │  │
│          │  └────────────────────────────────────────────┘  │
└──────────┴──────────────────────────────────────────────────┘
```

### 3.2 Component Details

#### 3.2.1 Journal Header Section

**Fields:**

| Field | Type | Required | Validation | Default |
|-------|------|----------|------------|---------|
| Journal Number | Text (read-only) | Yes | Auto-generated | JE-YYYY-#### |
| Entry Date | Date | Yes | Not null | Today |
| Posting Date | Date | No | >= Entry Date | Entry Date |
| Period | Dropdown | Yes | Must be open period | Current period |
| Description | Textarea | Yes | Max 500 chars | - |
| Status | Badge (read-only) | Yes | DRAFT / POSTED | DRAFT |

**Business Rules:**
- Journal Number format: `JE-YYYY-####` (e.g., JE-2024-0001)
- Posting Date defaults to Entry Date if empty
- Period must match Entry Date month
- Status changes from DRAFT → POSTED (one-way, irreversible)

#### 3.2.2 Journal Lines Table

**Columns:**

| Column | Width | Description |
|--------|-------|-------------|
| # | 50px | Line number (auto-numbered) |
| Account | 200px | Account code + name (clickable to select) |
| Description | 150px+ | Line description (text input) |
| Debit | 120px | Debit amount (number input, right-aligned) |
| Credit | 120px | Credit amount (number input, right-aligned) |
| Dimensions | 200px+ | Dimension tags (shows assigned dimensions) |
| Actions | 150px | Split / Delete buttons |

**Row Features:**
- **Account Column**: Shows selected account OR "Select Account" button if empty
- **Debit/Credit**: Mutually exclusive - entering debit disables credit and vice versa
- **Dimensions Column**: Shows dimension tags (e.g., "Cost Center: Production")
- **Split Button**: Available only if account has dimensions
- **Delete Button**: Removes line from table

**Add Line Button:**
- Location: Above table
- Action: Adds new empty line to bottom of table
- Style: Primary button (blue)

#### 3.2.3 Totals & Balance Section

**Display:**
- **Total Debit**: Sum of all debit amounts
- **Total Credit**: Sum of all credit amounts
- **Difference**: |Total Debit - Total Credit|
- **Balance Status**: ✅ Balanced / ⚠️ Not balanced

**Styling:**
- Background: Light orange (#fff3e0)
- Border-left: 4px solid orange (#ff9800)
- Difference value: Green if 0, Red if > 0

**Validation Alert:**
- ✅ Green alert: "Journal is balanced (Debit = Credit)" when difference = 0
- ⚠️ Red alert: "Journal is not balanced. Difference: X,XXX,XXX" when difference > 0

### 3.3 Modal: Account Selection

**Trigger:** Click "Select Account" button in journal line

**Layout:**

```
┌─────────────────────────────────────────────┐
│ Select Account                          [X] │
├─────────────────────────────────────────────┤
│ Search: [__________________________]        │
│                                             │
│ ┌─────────────────────────────────────────┐│
│ │ 1121 - Cash on Hand            (Asset) ││
│ │ 1122 - Cash in Bank - VCB      (Asset) ││
│ │ 1131 - Accounts Receivable     (Asset) ││
│ │ 2111 - Accounts Payable    (Liability) ││
│ │ 6271 - Depreciation Expense  (Expense) ││
│ │ ...                                     ││
│ └─────────────────────────────────────────┘│
└─────────────────────────────────────────────┘
```

**Features:**
- **Search Box**: Filter by account code or name (real-time)
- **Account List**: Scrollable list of all active accounts
- **Account Format**: `CODE - NAME (Type)`
- **Click to Select**: Click any account to select and close modal

### 3.4 Modal: Dimension Split

**Trigger:** Click "Split" button on journal line with dimensions

**Layout:**

```
┌──────────────────────────────────────────────────────┐
│ Split Dimension                               [X]    │
├──────────────────────────────────────────────────────┤
│ Select Dimension: [Cost Center ▼]                   │
│                                                      │
│ Use Split Template: [Sales Split (60-40) ▼]        │
│                                                      │
│ Split Lines:                                         │
│ ┌──────────────────────────────────────────────────┐│
│ │ [Sales - North ▼]    [60.00]  %    [X]          ││
│ │ [Sales - South ▼]    [40.00]  %    [X]          ││
│ │                                                  ││
│ │ [+ Add Split Line]                               ││
│ │                                                  ││
│ │ Total: 100.00% ✅                                ││
│ └──────────────────────────────────────────────────┘│
│                                                      │
│                          [Cancel] [Apply Split]     │
└──────────────────────────────────────────────────────┘
```

**Features:**
- **Dimension Dropdown**: Shows only dimensions applicable to selected account
- **Template Dropdown**: Shows split templates for selected dimension (optional)
- **Split Lines**: Minimum 2 lines, maximum unlimited
- **Dimension Value**: Dropdown of dimension values (LEAF NODES ONLY)
- **Percentage Input**: Number input (0-100, up to 2 decimals)
- **Add/Remove Lines**: Dynamic addition/removal of split lines
- **Total Validation**: Real-time calculation, must equal 100%
- **Apply Button**: Disabled if total ≠ 100% or any value not selected

### 3.5 Header Buttons

| Button | Style | Action | Validation |
|--------|-------|--------|------------|
| **Save Draft** | Green | Save journal as DRAFT | Basic validation (required fields, line structure) |
| **Post** | Blue | Post journal to ledger | Strict validation (balanced entry, all dimensions assigned) |
| **Close** | Red | Close form and return | Confirm if unsaved changes |

---

## 4. User Workflows

### 4.1 Create Manual Journal Entry (Happy Path)

**Actors:** Accountant

**Preconditions:**
- User has permission to create journal entries
- At least one open period exists
- Chart of Accounts configured

**Main Flow:**

1. User navigates to "Manual Journal Entry" screen
2. System displays form with:
   - Auto-generated journal number (read-only)
   - Entry Date = Today
   - Status = DRAFT
3. User fills Journal Header:
   - Entry Date: 2024-10-31
   - Period: October 2024
   - Description: "Monthly depreciation - October 2024"
4. User clicks **[+ Add Line]** to add first line
5. User clicks **[Select Account]** button
6. System opens Account Selection modal
7. User searches for "6271" → selects "6271 - Depreciation Expense"
8. System closes modal and assigns account to line
9. System displays applicable dimensions for account (Cost Center, Asset Type)
10. User enters:
    - Description: "Monthly depreciation - Buildings"
    - Debit Amount: 5,000,000
11. User clicks **[Split]** button on Cost Center dimension
12. System opens Dimension Split modal
13. User selects:
    - Dimension: Cost Center
    - Template: "Equal Split All Centers"
14. System loads template lines (4 centers, 25% each)
15. User clicks **[Apply Split]**
16. System shows dimension split tag: "Cost Center: Split (4 values)"
17. User repeats steps 4-10 for credit line:
    - Account: 2141 - Accumulated Depreciation
    - Credit Amount: 5,000,000
    - Dimension: Asset Type = BUILDING (single value)
18. System validates balance: Total Debit (5,000,000) = Total Credit (5,000,000) ✅
19. User clicks **[Post]**
20. System validates:
    - All required fields filled ✅
    - All lines have accounts ✅
    - Entry is balanced ✅
    - All dimensions assigned ✅
21. System creates journal entry:
    - 1 journal record (header)
    - 5 journal_lines records (1 credit line + 4 debit lines from split)
    - 5 journal_line_dimensions records
22. System updates status to POSTED
23. System disables Post button
24. System shows success message: "✅ Journal posted successfully!"

**Postconditions:**
- Journal entry saved in database with status = POSTED
- Journal lines created with proper debit/credit amounts
- Dimension splits expanded into multiple lines
- Entry appears in General Ledger

### 4.2 Save as Draft (Partial Entry)

**Main Flow:**

1. User fills Journal Header (partial information)
2. User adds 1-2 lines (incomplete, not balanced)
3. User clicks **[Save Draft]**
4. System validates:
   - Entry Date filled? ✅
   - Period selected? ✅
   - Description filled? ✅
5. System saves journal with status = DRAFT
6. System shows message: "✅ Journal saved as DRAFT"
7. User can return later to complete and post

**Key Differences from Posting:**
- ❌ Does NOT validate balance (debit = credit)
- ❌ Does NOT require all lines to have accounts
- ❌ Does NOT require all dimensions assigned
- ✅ Allows incomplete entries
- ✅ Can edit/delete later

### 4.3 Dimension Split with Template

**Actors:** Accountant

**Scenario:** Split depreciation expense across 4 cost centers equally

**Flow:**

1. User adds journal line with account "6271 - Depreciation Expense"
2. User enters debit amount: 10,000,000
3. User clicks **[Split]** button next to "Cost Center" dimension
4. System opens Dimension Split modal
5. User selects:
   - Dimension: **Cost Center**
   - Template: **Equal Split All Centers**
6. System loads template:
   - Sales - North: 25%
   - Sales - South: 25%
   - Marketing: 25%
   - Production: 25%
   - **Total: 100%** ✅
7. User clicks **[Apply Split]**
8. System:
   - Stores split configuration on journal line
   - Shows tag: "Cost Center: Split (4 values)"
9. **When posting**, system expands into 4 journal_lines:
   - Line 1: Debit 2,500,000, Cost Center = SALES_NORTH
   - Line 2: Debit 2,500,000, Cost Center = SALES_SOUTH
   - Line 3: Debit 2,500,000, Cost Center = MARKETING
   - Line 4: Debit 2,500,000, Cost Center = PRODUCTION

**Key Point:** Split lines are NOT created in UI table - they are expanded during posting to database.

### 4.4 Multi-Dimensional Split (Advanced)

**Scenario:** Split expense across Cost Centers AND Projects

**Flow:**

1. User adds line: "6621 - Consulting Expense", Debit: 12,000,000
2. Account has 2 dimensions: Cost Center, Project
3. User splits **Cost Center**:
   - Sales - North: 60%
   - Sales - South: 40%
4. User splits **Project**:
   - Project Alpha: 70%
   - Project Beta: 30%
5. **When posting**, system creates **Cartesian Product** (2 × 2 = 4 lines):
   - Line 1: 5,040,000 (12M × 60% × 70%), Cost Center=SALES_NORTH, Project=PROJ_ALPHA
   - Line 2: 2,160,000 (12M × 60% × 30%), Cost Center=SALES_NORTH, Project=PROJ_BETA
   - Line 3: 3,360,000 (12M × 40% × 70%), Cost Center=SALES_SOUTH, Project=PROJ_ALPHA
   - Line 4: 1,440,000 (12M × 40% × 30%), Cost Center=SALES_SOUTH, Project=PROJ_BETA
   - **Total: 12,000,000** ✅

---

## 5. Business Rules

### 5.1 Journal Entry Rules

| Rule Code | Rule Description | Enforcement |
|-----------|------------------|-------------|
| **BR-JE-001** | Journal number must be unique per tenant | Database constraint (unique index) |
| **BR-JE-002** | Journal number format: `JE-YYYY-####` (auto-generated) | Backend service |
| **BR-JE-003** | Entry Date cannot be more than 30 days in past | Frontend + Backend validation |
| **BR-JE-004** | Posting Date must be >= Entry Date | Frontend + Backend validation |
| **BR-JE-005** | Period must be OPEN status | Backend validation |
| **BR-JE-006** | Period must match Entry Date month | Backend validation |
| **BR-JE-007** | Journal must have at least 2 lines (debit + credit) | Frontend + Backend validation |
| **BR-JE-008** | Total Debit must equal Total Credit before posting | Frontend + Backend validation |
| **BR-JE-009** | Posted journal cannot be edited or deleted | UI disabled + Backend check |
| **BR-JE-010** | Posted journal can only be reversed (creates new entry) | UI workflow |

### 5.2 Journal Line Rules

| Rule Code | Rule Description | Enforcement |
|-----------|------------------|-------------|
| **BR-LINE-001** | Each line must have exactly one account | Frontend + Backend validation |
| **BR-LINE-002** | Each line must have either Debit OR Credit (not both) | Frontend + Backend validation (CHECK constraint) |
| **BR-LINE-003** | Debit/Credit amount must be > 0 | Frontend + Backend validation |
| **BR-LINE-004** | Account must be ACTIVE and POSTABLE | Backend validation |
| **BR-LINE-005** | If account has dimension rules, dimensions must be assigned | Backend validation |
| **BR-LINE-006** | Dimension values must be from allowed list (account-dimension rules) | Backend validation |
| **BR-LINE-007** | Dimension values must be ACTIVE | Backend validation |
| **BR-LINE-008** | Dimension values must be LEAF NODES (if split template used) | Backend validation |

### 5.3 Dimension Split Rules

| Rule Code | Rule Description | Enforcement |
|-----------|------------------|-------------|
| **BR-SPLIT-001** | Split percentages must total 100.00% | Frontend + Backend validation |
| **BR-SPLIT-002** | Split must have at least 2 lines | Frontend + Backend validation |
| **BR-SPLIT-003** | Each split line must have a dimension value | Frontend + Backend validation |
| **BR-SPLIT-004** | Dimension values in split must be unique (no duplicates) | Frontend + Backend validation |
| **BR-SPLIT-005** | Split dimension values must be LEAF NODES only | Backend validation |
| **BR-SPLIT-006** | Multi-dimensional splits create Cartesian Product of values | Backend posting logic |
| **BR-SPLIT-007** | Total amount after split expansion must equal original line amount | Backend validation |

### 5.4 Period Control Rules

| Rule Code | Rule Description | Enforcement |
|-----------|------------------|-------------|
| **BR-PERIOD-001** | Can only post to OPEN periods | Backend validation |
| **BR-PERIOD-002** | Cannot post to CLOSED or LOCKED periods | Backend validation |
| **BR-PERIOD-003** | Period must match fiscal year of Entry Date | Backend validation |

---

## 6. Validation Rules

### 6.1 Frontend Validation (Real-time)

**Journal Header:**
```javascript
// Required field validation
if (!entryDate) {
    error("Entry Date is required");
}

if (!period) {
    error("Period is required");
}

if (!description || description.trim() === '') {
    error("Description is required");
}

// Date validation
if (postingDate && postingDate < entryDate) {
    error("Posting Date cannot be before Entry Date");
}

// Entry Date not too far in past
const daysDiff = (today - entryDate) / (1000 * 60 * 60 * 24);
if (daysDiff > 30) {
    warning("Entry Date is more than 30 days in the past");
}
```

**Journal Lines:**
```javascript
// Account selection
if (!line.account) {
    error("Please select an account for all lines");
}

// Debit OR Credit (not both)
if (line.debit && line.credit) {
    error("Line cannot have both debit and credit");
}

if (!line.debit && !line.credit) {
    error("Line must have either debit or credit amount");
}

// Amount > 0
if (line.debit && line.debit <= 0) {
    error("Debit amount must be greater than 0");
}

if (line.credit && line.credit <= 0) {
    error("Credit amount must be greater than 0");
}
```

**Balance Validation:**
```javascript
const totalDebit = lines.reduce((sum, l) => sum + (l.debit || 0), 0);
const totalCredit = lines.reduce((sum, l) => sum + (l.credit || 0), 0);

if (totalDebit !== totalCredit) {
    error("Journal is not balanced. Debit total must equal Credit total.");
}
```

**Dimension Split:**
```javascript
const totalPercentage = splitLines.reduce((sum, l) => sum + l.percentage, 0);

if (totalPercentage !== 100) {
    error("Split percentages must total 100%");
}

if (splitLines.some(l => !l.dimensionValue)) {
    error("All split lines must have a dimension value selected");
}

// Check for duplicates
const values = splitLines.map(l => l.dimensionValue);
if (values.length !== new Set(values).size) {
    error("Duplicate dimension values in split");
}
```

### 6.2 Backend Validation (Pre-POST)

**Validation Sequence:**

1. **Header Validation:**
   - Journal number unique
   - Entry Date not null
   - Period exists and is OPEN
   - Period matches Entry Date month
   - Description not empty

2. **Lines Validation:**
   - At least 2 lines
   - All lines have accounts
   - All accounts are ACTIVE
   - Each line has debit XOR credit (not both)
   - All amounts > 0

3. **Balance Validation:**
   - SUM(debit) = SUM(credit)

4. **Dimension Validation:**
   - For each line with account that has dimension rules:
     - Check all required dimensions are assigned
     - Check dimension values are in allowed list
     - Check dimension values are ACTIVE
     - If split: validate split percentages = 100%

5. **Period Control:**
   - Period status = OPEN
   - Entry Date within period date range

6. **Transaction Integrity:**
   - Create journal record
   - Create journal_lines records (expand splits)
   - Create journal_line_dimensions records
   - Update journal totals
   - Update period statistics (optional)

---

## 7. Data Model Integration

### 7.1 Tables Used

#### Primary Tables:

| Table | Purpose |
|-------|---------|
| `journals` | Journal entry header |
| `journal_lines` | Journal entry lines (NO dimension columns) |
| `journal_line_dimensions` | Many-to-many dimension assignments |

#### Reference Tables:

| Table | Purpose |
|-------|---------|
| `accounts` | Chart of Accounts |
| `periods` | Fiscal periods (open/closed control) |
| `dimensions` | Dimension definitions |
| `dimension_values` | Dimension value master data |
| `account_dimension_rules` | Whitelist of allowed dimensions per account |
| `dimension_split_templates` | Reusable split templates |

### 7.2 Data Flow: Journal Entry Creation

**Step 1: Create Journal Header**

```sql
INSERT INTO journals (
    tenant_id,
    journal_number,
    entry_date,
    posting_date,
    period_id,
    description,
    total_debit,
    total_credit,
    status,
    created_by,
    created_at
) VALUES (
    'tenant-001',
    'JE-2024-0001',
    '2024-10-31',
    '2024-10-31',
    'period-2024-10',
    'Monthly depreciation - October 2024',
    5000000,
    5000000,
    'POSTED',
    'user-123',
    NOW()
);
```

**Step 2: Expand Split Lines (if any)**

**UI Data (before posting):**
```json
{
  "lines": [
    {
      "account": "6271",
      "debit": 10000000,
      "credit": null,
      "dimensions": {
        "cost_center": [
          { "value": "SALES_NORTH", "percentage": 25 },
          { "value": "SALES_SOUTH", "percentage": 25 },
          { "value": "MARKETING", "percentage": 25 },
          { "value": "PRODUCTION", "percentage": 25 }
        ]
      }
    },
    {
      "account": "2141",
      "debit": null,
      "credit": 10000000,
      "dimensions": {
        "asset_type": "BUILDING"
      }
    }
  ]
}
```

**Database Records (after posting):**

```sql
-- Journal Lines (5 records)
INSERT INTO journal_lines VALUES
  ('line-1', 'journal-1', 1, 'account-6271', 2500000, NULL, ...),  -- Split 1
  ('line-2', 'journal-1', 2, 'account-6271', 2500000, NULL, ...),  -- Split 2
  ('line-3', 'journal-1', 3, 'account-6271', 2500000, NULL, ...),  -- Split 3
  ('line-4', 'journal-1', 4, 'account-6271', 2500000, NULL, ...),  -- Split 4
  ('line-5', 'journal-1', 5, 'account-2141', NULL, 10000000, ...); -- Credit

-- Journal Line Dimensions (5 records)
INSERT INTO journal_line_dimensions VALUES
  ('jld-1', 'line-1', 'dim-cost-center', 'SALES_NORTH'),
  ('jld-2', 'line-2', 'dim-cost-center', 'SALES_SOUTH'),
  ('jld-3', 'line-3', 'dim-cost-center', 'MARKETING'),
  ('jld-4', 'line-4', 'dim-cost-center', 'PRODUCTION'),
  ('jld-5', 'line-5', 'dim-asset-type', 'BUILDING');
```

### 7.3 Split Expansion Logic (Multi-Dimensional)

**Example:** Split across Cost Center (2 values) AND Project (2 values)

**Input:**
- Amount: 12,000,000 VNĐ
- Cost Center Split: Sales North (60%), Sales South (40%)
- Project Split: Project Alpha (70%), Project Beta (30%)

**Expansion Algorithm:**

```python
def expand_multi_dimensional_split(line):
    """
    Expand a journal line with multi-dimensional splits into multiple journal_lines
    using Cartesian Product.
    """
    # Get base amount
    base_amount = line.debit or line.credit
    is_debit = line.debit is not None

    # Initialize with one combination
    combinations = [{'amount': base_amount, 'dimensions': {}}]

    # For each dimension with split
    for dim_key, split_values in line.dimensions.items():
        if isinstance(split_values, list):  # Is a split
            new_combinations = []

            for combination in combinations:
                for split_value in split_values:
                    new_comb = {
                        'amount': combination['amount'] * (split_value.percentage / 100),
                        'dimensions': {
                            **combination['dimensions'],
                            dim_key: split_value.value
                        }
                    }
                    new_combinations.append(new_comb)

            combinations = new_combinations
        else:  # Single value
            for combination in combinations:
                combination['dimensions'][dim_key] = split_values

    # Create journal_lines records
    journal_lines = []
    for i, comb in enumerate(combinations):
        journal_lines.append({
            'line_number': base_line_number + i,
            'account_id': line.account_id,
            'debit_amount': round(comb['amount'], 2) if is_debit else None,
            'credit_amount': round(comb['amount'], 2) if not is_debit else None,
            'dimensions': comb['dimensions']
        })

    return journal_lines
```

**Output (4 journal_lines):**

| Line | Account | Debit | Credit | Cost Center | Project | Calculation |
|------|---------|-------|--------|-------------|---------|-------------|
| 1 | 6621 | 5,040,000 | - | SALES_NORTH | PROJ_ALPHA | 12M × 60% × 70% |
| 2 | 6621 | 2,160,000 | - | SALES_NORTH | PROJ_BETA | 12M × 60% × 30% |
| 3 | 6621 | 3,360,000 | - | SALES_SOUTH | PROJ_ALPHA | 12M × 40% × 70% |
| 4 | 6621 | 1,440,000 | - | SALES_SOUTH | PROJ_BETA | 12M × 40% × 30% |

**Validation:** 5,040,000 + 2,160,000 + 3,360,000 + 1,440,000 = **12,000,000** ✅

---

## 8. Dimension Split Integration

### 8.1 How Dimension Split Works

**Concept:** Instead of posting ONE journal line with a single dimension value, user can split the line across MULTIPLE dimension values with specified percentages.

**Use Case Example:**

**Without Split:**
```
Journal Line:
- Account: 6421 - Salaries Expense
- Debit: 100,000,000
- Cost Center: ??? (Which center? All salary is for one center?)
```

**With Split:**
```
Journal Line (UI):
- Account: 6421 - Salaries Expense
- Debit: 100,000,000
- Cost Center: SPLIT
  - Sales North: 40%
  - Sales South: 30%
  - Marketing: 20%
  - Production: 10%

Result (Database - 4 lines):
Line 1: Debit 40,000,000, Cost Center = SALES_NORTH
Line 2: Debit 30,000,000, Cost Center = SALES_SOUTH
Line 3: Debit 20,000,000, Cost Center = MARKETING
Line 4: Debit 10,000,000, Cost Center = PRODUCTION
```

### 8.2 Split Template Usage

**Flow:**

1. User clicks **[Split]** button on journal line
2. System opens Dimension Split modal
3. User selects dimension (e.g., "Cost Center")
4. User selects template (e.g., "Sales Split (60-40)")
5. System loads template:
   - Sales North: 60%
   - Sales South: 40%
6. User can:
   - ✅ Keep template values as-is
   - ✅ Modify percentages
   - ✅ Add/remove lines
   - ✅ Switch to different template
7. User clicks **[Apply Split]**
8. System saves split configuration to line

**Benefits:**
- **Consistency**: Same split pattern across multiple journal entries
- **Efficiency**: No need to manually enter percentages every time
- **Accuracy**: Pre-validated templates reduce errors

### 8.3 Split vs Single Value

| Aspect | Single Value | Split (Multiple Values) |
|--------|--------------|------------------------|
| **UI Display** | Tag: "Cost Center: Production" | Tag: "Cost Center: Split (4 values)" |
| **Database Lines** | 1 journal_line | 4 journal_lines (one per split value) |
| **Amount** | Full amount | Amount × Percentage |
| **Use Case** | Expense belongs to ONE center | Expense shared across MULTIPLE centers |
| **Modification** | Change dropdown | Reopen split modal, modify percentages |

---

## 9. Test Scenarios

### 9.1 Test Case 1: Simple Balanced Entry

**Objective:** Create and post a simple 2-line balanced journal entry

**Test Data:**
- Entry Date: 2024-10-31
- Period: October 2024
- Description: "Test entry - simple"
- Line 1: Account 1121 (Cash), Debit 1,000,000, Cost Center = SALES_NORTH
- Line 2: Account 5111 (Revenue), Credit 1,000,000, Cost Center = SALES_NORTH

**Steps:**
1. Fill journal header
2. Add line 1: Account 1121, Debit 1,000,000, Cost Center = SALES_NORTH
3. Add line 2: Account 5111, Credit 1,000,000, Cost Center = SALES_NORTH
4. Verify balance: Debit = Credit = 1,000,000 ✅
5. Click **[Post]**
6. Verify: Status = POSTED, Post button disabled

**Expected Result:** ✅ Journal posted successfully, 2 journal_lines created

---

### 9.2 Test Case 2: Multi-Line Entry with Split

**Objective:** Test dimension split with 4 split values

**Test Data:**
- Entry Date: 2024-10-31
- Period: October 2024
- Description: "Monthly depreciation - All centers"
- Line 1: Account 6271 (Depreciation Expense), Debit 4,000,000, Split Cost Center 4 ways (25% each)
- Line 2: Account 2141 (Accumulated Depreciation), Credit 4,000,000, Asset Type = BUILDING

**Steps:**
1. Add line 1: Account 6271, Debit 4,000,000
2. Click **[Split]** on Cost Center
3. Select dimension: Cost Center
4. Select template: "Equal Split All Centers"
5. Verify split lines:
   - Sales North: 25%
   - Sales South: 25%
   - Marketing: 25%
   - Production: 25%
   - Total: 100% ✅
6. Click **[Apply Split]**
7. Verify UI shows: "Cost Center: Split (4 values)"
8. Add line 2: Account 2141, Credit 4,000,000, Asset Type = BUILDING
9. Verify balance: Debit = Credit = 4,000,000 ✅
10. Click **[Post]**
11. Query database: `SELECT * FROM journal_lines WHERE journal_id = ?`

**Expected Result:**
- ✅ 5 journal_lines created (4 debit + 1 credit)
- ✅ Line 1: Debit 1,000,000, Cost Center = SALES_NORTH
- ✅ Line 2: Debit 1,000,000, Cost Center = SALES_SOUTH
- ✅ Line 3: Debit 1,000,000, Cost Center = MARKETING
- ✅ Line 4: Debit 1,000,000, Cost Center = PRODUCTION
- ✅ Line 5: Credit 4,000,000, Asset Type = BUILDING

---

### 9.3 Test Case 3: Multi-Dimensional Split (Cartesian Product)

**Objective:** Test split across 2 dimensions (Cost Center × Project)

**Test Data:**
- Entry Date: 2024-10-31
- Line 1: Account 6621 (Consulting Expense), Debit 10,000,000
  - Cost Center Split: Sales North (60%), Sales South (40%)
  - Project Split: Project Alpha (70%), Project Beta (30%)
- Line 2: Account 1122 (Cash in Bank), Credit 10,000,000

**Steps:**
1. Add line 1: Account 6621, Debit 10,000,000
2. Split Cost Center: Sales North (60%), Sales South (40%)
3. Split Project: Project Alpha (70%), Project Beta (30%)
4. Add line 2: Account 1122, Credit 10,000,000
5. Click **[Post]**
6. Query database

**Expected Result:**
- ✅ 5 journal_lines created (4 debit + 1 credit)
- ✅ Line 1: Debit 4,200,000, Cost Center = SALES_NORTH, Project = PROJ_ALPHA (10M × 60% × 70%)
- ✅ Line 2: Debit 1,800,000, Cost Center = SALES_NORTH, Project = PROJ_BETA (10M × 60% × 30%)
- ✅ Line 3: Debit 2,800,000, Cost Center = SALES_SOUTH, Project = PROJ_ALPHA (10M × 40% × 70%)
- ✅ Line 4: Debit 1,200,000, Cost Center = SALES_SOUTH, Project = PROJ_BETA (10M × 40% × 30%)
- ✅ Line 5: Credit 10,000,000
- ✅ Total: 4,200,000 + 1,800,000 + 2,800,000 + 1,200,000 = 10,000,000 ✅

---

### 9.4 Test Case 4: Unbalanced Entry (Negative Test)

**Objective:** Verify system prevents posting unbalanced entries

**Test Data:**
- Line 1: Debit 5,000,000
- Line 2: Credit 3,000,000
- Difference: 2,000,000

**Steps:**
1. Fill header
2. Add line 1: Debit 5,000,000
3. Add line 2: Credit 3,000,000
4. Verify UI shows: "⚠️ Journal is not balanced. Difference: 2,000,000"
5. Click **[Post]**

**Expected Result:**
- ❌ Validation error: "Journal must be balanced (Debit = Credit) before posting"
- ❌ Journal NOT posted

---

### 9.5 Test Case 5: Save as Draft (Incomplete Entry)

**Objective:** Verify draft save allows incomplete/unbalanced entries

**Test Data:**
- Line 1: Debit 5,000,000 (no account selected)
- Line 2: Not added
- Unbalanced

**Steps:**
1. Fill header only (Entry Date, Period, Description)
2. Add line 1 with Debit 5,000,000 but NO account
3. Click **[Save Draft]**

**Expected Result:**
- ✅ Draft saved successfully (status = DRAFT)
- ✅ User can return later to complete

---

### 9.6 Test Case 6: Closed Period Validation

**Objective:** Verify system prevents posting to closed periods

**Test Data:**
- Entry Date: 2024-09-15
- Period: September 2024 (status = CLOSED)

**Steps:**
1. Fill header with Entry Date = 2024-09-15
2. Select Period: September 2024
3. Add balanced lines
4. Click **[Post]**

**Expected Result:**
- ❌ Validation error: "Cannot post to closed period"
- ❌ Journal NOT posted

---

### 9.7 Test Case 7: Account Without Dimensions

**Objective:** Verify journal lines work correctly for accounts without dimension rules

**Test Data:**
- Line 1: Account 1121 (Cash on Hand - no dimension rules), Debit 1,000,000
- Line 2: Account 5111 (Revenue - has dimension rules), Credit 1,000,000, Cost Center = SALES_NORTH

**Steps:**
1. Add line 1: Account 1121, Debit 1,000,000
2. Verify: No dimension dropdown shown, No [Split] button
3. Add line 2: Account 5111, Credit 1,000,000
4. Verify: Dimension dropdown shown, [Split] button available
5. Assign Cost Center = SALES_NORTH
6. Click **[Post]**

**Expected Result:**
- ✅ 2 journal_lines created
- ✅ Line 1: No dimensions (journal_line_dimensions count = 0 for line 1)
- ✅ Line 2: 1 dimension (Cost Center)

---

## 10. Technical Notes

### 10.1 Performance Considerations

**Large Journal Entries:**
- Support up to 100 lines without performance degradation
- Use pagination for account selection dropdown (show 50 at a time)
- Debounce account search (300ms delay)

**Split Expansion:**
- Limit splits to max 20 dimension values per dimension
- Limit multi-dimensional split to max 100 total combinations (e.g., 10 × 10)
- Validate total combinations before posting

**Database Indexing:**
```sql
-- Critical indexes for journal queries
CREATE INDEX idx_journals_tenant_date ON journals(tenant_id, entry_date);
CREATE INDEX idx_journals_period ON journals(period_id);
CREATE INDEX idx_journal_lines_journal ON journal_lines(journal_id);
CREATE INDEX idx_journal_lines_account ON journal_lines(account_id);
CREATE INDEX idx_jld_line ON journal_line_dimensions(journal_line_id);
CREATE INDEX idx_jld_dimension_value ON journal_line_dimensions(dimension_value_id);
```

### 10.2 Security Considerations

**Access Control:**
- User must have permission: `accounting.journal_entry.create`
- User must have permission: `accounting.journal_entry.post` (separate from create)
- Audit log: All journal entry creations, modifications, postings

**Data Validation:**
- All user inputs sanitized (XSS prevention)
- SQL injection prevention (parameterized queries)
- CSRF token validation on POST requests

**Audit Trail:**
```sql
CREATE TABLE journal_audit_log (
    id UUID PRIMARY KEY,
    journal_id UUID NOT NULL,
    action VARCHAR(20) NOT NULL,  -- CREATE, UPDATE, POST, REVERSE
    user_id UUID NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    changes JSONB  -- Before/after values
);
```

### 10.3 Future Enhancements

| Enhancement | Description | Priority |
|-------------|-------------|----------|
| **Multi-Currency** | Support foreign currency journal entries | HIGH |
| **Attachment Upload** | Attach supporting documents (PDF, images) | MEDIUM |
| **Journal Templates** | Reusable journal entry templates (e.g., monthly depreciation) | MEDIUM |
| **Approval Workflow** | Multi-level approval before posting | MEDIUM |
| **Recurring Journals** | Auto-generate recurring entries (e.g., monthly rent) | LOW |
| **Bulk Import** | Import journal entries from Excel/CSV | LOW |
| **AI-Suggested Accounts** | ML-based account suggestion based on description | LOW |

### 10.4 Integration Points

**Upstream Systems:**
- **Initial Balance Module**: Creates opening balance journal entries
- **Cash In/Out Module**: Generates journal entries for cash transactions
- **Purchase/Sales Modules**: Generate journal entries for invoices
- **Payroll Module**: Generates journal entries for salary payments

**Downstream Systems:**
- **General Ledger**: Journal entries populate GL for reporting
- **Trial Balance**: Calculates from journal entries
- **Financial Statements**: P&L, Balance Sheet use journal data

---

## Appendix A: Mock Data Reference

### A.1 Sample Accounts

```javascript
const accountsData = [
    { code: '1121', name: 'Cash on Hand', type: 'Asset', dimensions: ['cost_center'] },
    { code: '1122', name: 'Cash in Bank - VCB', type: 'Asset', dimensions: ['cost_center'] },
    { code: '1131', name: 'Accounts Receivable', type: 'Asset', dimensions: ['cost_center', 'project'] },
    { code: '2111', name: 'Accounts Payable', type: 'Liability', dimensions: ['cost_center', 'project'] },
    { code: '6271', name: 'Depreciation Expense', type: 'Expense', dimensions: ['cost_center', 'asset_type'] },
    { code: '2141', name: 'Accumulated Depreciation', type: 'Asset', dimensions: ['asset_type'] },
    { code: '5111', name: 'Product Sales Revenue', type: 'Revenue', dimensions: ['cost_center', 'project', 'product_line'] },
    { code: '6421', name: 'Salaries Expense', type: 'Expense', dimensions: ['cost_center', 'department'] },
];
```

### A.2 Sample Dimension Values

```javascript
const dimensionValues = {
    cost_center: ['SALES_NORTH', 'SALES_SOUTH', 'MARKETING', 'PRODUCTION'],
    project: ['PROJ_2024_001', 'PROJ_2024_002', 'PROJ_2024_003'],
    asset_type: ['BUILDING', 'EQUIPMENT', 'VEHICLE', 'COMPUTER'],
    product_line: ['PROD_A', 'PROD_B'],
    department: ['DEPT_HR', 'DEPT_FINANCE', 'DEPT_IT']
};
```

### A.3 Sample Split Templates

```javascript
const splitTemplates = {
    cost_center: [
        {
            code: 'TMPL_CC_SALES',
            name: 'Sales Split (60-40)',
            lines: [
                { value: 'SALES_NORTH', percentage: 60 },
                { value: 'SALES_SOUTH', percentage: 40 }
            ]
        },
        {
            code: 'TMPL_CC_EQUAL',
            name: 'Equal Split All Centers',
            lines: [
                { value: 'SALES_NORTH', percentage: 25 },
                { value: 'SALES_SOUTH', percentage: 25 },
                { value: 'MARKETING', percentage: 25 },
                { value: 'PRODUCTION', percentage: 25 }
            ]
        }
    ]
};
```

---

## Document Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2024-10-31 | AI Agent | Initial creation - Complete design specification for Manual Journal Entry |

---

**End of Document**
