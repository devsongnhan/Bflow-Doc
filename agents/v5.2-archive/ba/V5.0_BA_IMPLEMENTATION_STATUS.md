# V5.0 BA Agent Implementation Status

**Date**: 2025-10-19
**Version**: 5.0
**Status**: Core Infrastructure Complete

---

## üìã Overview

V5.0 introduces BA (Business Analyst) Agent to create requirements and design documents that PM reviews and approves before Sprint planning.

### Workflow
```
BA ‚Üí Create Docs ‚Üí Submit for Review ‚Üí PM Review ‚Üí Approve
                                              ‚Üì
                        PM Create Sprint Plan (with design doc refs)
                                              ‚Üì
                        Dev Reads Design Doc ‚Üí Implements
```

---

## ‚úÖ Completed Components

### 1. Directory Structure
- ‚úÖ `Docs/requirements/` - BA requirements documents
- ‚úÖ `Docs/requirements/templates/` - Requirements template
- ‚úÖ `Docs/design/` - BA design documents
- ‚úÖ `Docs/design/templates/` - Design template
- ‚úÖ `agents/ba/` - BA agent code

### 2. Document Templates

#### Requirements Template
**File**: [Docs/requirements/templates/requirement-template.md](../../Docs/requirements/templates/requirement-template.md)

**Sections** (14 total):
1. Executive Summary
2. Business Requirements
3. Functional Requirements
4. Transaction Requirements (Accounting-specific)
5. Non-Functional Requirements
6. Data Requirements
7. Integration Requirements
8. Constraints and Assumptions
9. Risks and Mitigation
10. Test Requirements
11. Documentation Requirements
12. Glossary
13. Review History
14. Approval

**Features**:
- VAS compliance sections
- Legal requirements tracking
- User stories with acceptance criteria
- Test scenario tables
- PM approval checklist

#### Design Template
**File**: [Docs/design/templates/design-document-template.md](../../Docs/design/templates/design-document-template.md)

**Sections** (8 total):
1. Overview
2. Business Context
3. Technical Design (Accounting Logic, Parameters, Validation)
4. Implementation Specifications
5. Testing Requirements
6. Special Notes (VAS Compliance, Legal)
7. Review History
8. Approval

**Features**:
- Accounting logic tables (Debit/Credit with conditions)
- Parameter specifications with types and validation
- Code implementation guides with snippets
- Test scenario tables with inputs/outputs
- VAS compliance section
- Legal requirements (e.g., Ngh·ªã ƒë·ªãnh 181/2024)

### 3. BA Helper v5.0

**File**: [agents/ba/ba-helper-v5.0.js](./ba-helper-v5.0.js) (400+ lines)

**Key Methods**:
```javascript
// Document Creation
createRequirementDoc(docData)
createDesignDoc(docData)

// Document Management
loadDocument(doc_id, docType)
saveDocument(doc_id, document, docType)
getDocument(doc_id, docType)

// Review Workflow
submitDocumentForReview(doc_id, docType, notes)
updateDocumentAfterReview(doc_id, docType, reviewResult)

// Queries
listDocuments(docType)
getApprovedDesigns()
```

**Features**:
- Local JSON document storage
- Document lifecycle management (draft ‚Üí under_review ‚Üí approved/rejected)
- Integration with orchestrator API (when ready)
- Dual-mode authentication (LAN/Internet)

### 4. PM Helper Updates

**File**: [agents/pm/pm-helper-v5.0.js](../pm/pm-helper-v5.0.js)

**New Methods Added**:
```javascript
// Document Review
getNextDocument()
approveDocument(doc_id, feedback)
rejectDocument(doc_id, feedback)
listDocuments(status)

// Sprint Planning
getApprovedDesignsLocal()
validateSprintDesignReferences(sprint_id)
```

**Features**:
- Review BA documents
- Approve/reject with feedback
- Get approved designs for Sprint planning
- Validate Sprint tasks have design doc references

### 5. Configuration Updates

#### config.json
**File**: [orchestrator/shared/config.json](../../orchestrator/shared/config.json)

**Added**:
1. **Document Task Type**:
   ```json
   "document": {
     "name": "Document Review Task",
     "description": "Requirements and design documents created by BA for PM review",
     "workflow": ["ba", "pm", "reviewed"],
     "storage": "documents",
     "allowedTypes": ["requirement", "design"]
   }
   ```

2. **BA Role**:
   ```json
   "ba": {
     "name": "Business Analyst",
     "permissions": {
       "canCreate": ["document"],
       "canView": ["document", "sprint"],
       "canUpdate": ["document"]
     },
     "document": {
       "canCreateRequirements": true,
       "canCreateDesigns": true,
       "canSubmitForReview": true
     }
   }
   ```

3. **BA User**:
   ```json
   "ba-agent-1": {
     "username": "ba-agent-1",
     "apiKey": "ba-simple-key-67890",
     "role": "ba"
   }
   ```

4. **Document Endpoints**:
   ```json
   "document": {
     "ba": {
       "submitDocument": "/agent/ba/document/submit",
       "listDocuments": "/agent/ba/documents/list",
       "getApprovedDesigns": "/agent/ba/designs/approved"
     },
     "pm": {
       "getNextDocument": "/agent/pm/document/next",
       "approveDocument": "/agent/pm/document/:docId/approve",
       "rejectDocument": "/agent/pm/document/:docId/reject"
     }
   }
   ```

#### queue.json
**File**: [orchestrator/shared/queue.json](../../orchestrator/shared/queue.json)

**Added Documents Section**:
```json
"documents": {
  "_note": "V5.0: BA documents submitted for PM review",
  "_structure": {
    "review_task_id": "Unique review task ID",
    "doc_id": "Document ID (REQ-XXX or DES-XXX)",
    "doc_type": "requirement or design",
    "doc_name": "Document name",
    "feature_name": "Feature name",
    "submitted_by": "BA agent username",
    "status": "pending|approved|rejected"
  }
}
```

### 6. Sprint Plan Template Update

**File**: [Docs/sprints/templates/sprint-plan-template.json](../../Docs/sprints/templates/sprint-plan-template.json)

**Added to Task Template**:
```json
"ba_documents": {
  "requirement_doc_id": null,
  "requirement_doc_path": null,
  "design_doc_id": "DES-XXX",
  "design_doc_path": "Docs/design/DES-XXX.json",
  "design_doc_status": "approved",
  "_note": "REQUIRED: Each task MUST reference an approved design document from BA"
}
```

### 7. Documentation

#### BA Workflow Guide
**File**: [agents/ba/BA_WORKFLOW_GUIDE.md](./BA_WORKFLOW_GUIDE.md) (600+ lines)

**Contents**:
- Complete BA workflow explanation
- Step-by-step examples with code
- Document lifecycle diagram
- Method reference
- Important rules and validations
- Git sync instructions
- Troubleshooting guide

### 8. Demo/Test Files

#### BA Workflow Demo
**File**: [test-ba-v5-full.js](../../test-ba-v5-full.js) (400+ lines)

**Demonstrates**:
1. Create requirement document
2. Create design document
3. Submit for PM review (when orchestrator ready)
4. List documents
5. Get approved designs

**Sample Document**: Creates REQ-001 and DES-001 for AD001 feature with:
- Complete accounting logic (Debit/Credit tables)
- Parameter definitions
- Validation rules
- Test scenarios
- VAS compliance notes

---

## üöß Pending Work

### 1. Orchestrator Document APIs (High Priority)

**Need to Create**: Document handlers module

**File**: `orchestrator/shared/document-handlers-v5.0.js` (similar to sprint-handlers-v5.0.js)

**Required Handlers**:
```javascript
// BA handlers
handleSubmitDocument()      // POST /agent/ba/document/submit
handleListBADocuments()      // GET /agent/ba/documents/list
handleGetApprovedDesigns()   // GET /agent/ba/designs/approved

// PM handlers
handleGetNextDocument()      // GET /agent/pm/document/next
handleApproveDocument()      // POST /agent/pm/document/:docId/approve
handleRejectDocument()       // POST /agent/pm/document/:docId/reject
handleListPMDocuments()      // GET /agent/pm/documents/list
```

**Integration**: Add routes to `orchestrator-server-v5.0.js`

### 2. Document Review Workflow (Medium Priority)

**Tasks**:
1. Implement document queue in orchestrator
2. Create review task when BA submits document
3. PM gets next document to review
4. Update document status after PM review
5. Notify BA of review result

### 3. Sprint-Document Validation (Medium Priority)

**Tasks**:
1. Enforce design doc reference in Sprint tasks
2. Validate design doc exists and is approved
3. Prevent Sprint activation if validation fails
4. Add validation to PM Helper's `activateSprint()`

### 4. WebSocket Notifications (Low Priority)

**Tasks**:
1. Broadcast `document_submitted` when BA submits
2. Broadcast `document_reviewed` when PM reviews
3. Update dashboard to show document review status

### 5. Dashboard Updates (Low Priority)

**Tasks**:
1. Add "Documents" tab to dashboard
2. Show pending documents for PM review
3. Show BA's submitted documents with status
4. Link documents to Sprint tasks

---

## üìä Implementation Metrics

### Files Created/Modified
| Category | Files | Lines of Code |
|----------|-------|---------------|
| Templates | 2 | 700+ |
| BA Helper | 1 | 400+ |
| PM Helper | 1 (modified) | +150 |
| Config | 2 (modified) | +100 |
| Documentation | 2 | 1,000+ |
| Tests | 1 | 400+ |
| **Total** | **9** | **2,750+** |

### Document Template Features
- Requirements: 14 sections, 50+ fields
- Design: 8 sections, accounting logic tables, code snippets
- Both: VAS compliance, legal requirements, approval workflow

### BA Helper Features
- 10+ methods
- Local JSON storage
- Document lifecycle management
- Orchestrator API integration (prepared)

---

## üéØ Next Immediate Steps

### Step 1: Create Document Handlers
```bash
# Create document-handlers-v5.0.js
# Similar structure to sprint-handlers-v5.0.js
# Implement all BA and PM document methods
```

### Step 2: Integrate with Orchestrator
```bash
# Add document routes to orchestrator-server-v5.0.js
# Initialize documents state in loadQueue()
# Test BA submit ‚Üí PM review flow
```

### Step 3: Test End-to-End
```bash
# Run test-ba-v5-full.js (creates documents)
# Run PM review workflow (approve/reject)
# Run Sprint creation with design doc references
# Run Dev workflow (read design doc, implement)
```

---

## ‚ö†Ô∏è Important Rules

### 1. Design Document References
**CRITICAL**: Every Sprint task MUST reference an approved design document.

```javascript
// ‚ùå WRONG - No design doc reference
{
  task_id: 'sprint-001-task-001',
  title: 'Implement AD001'
  // Missing ba_documents!
}

// ‚úÖ CORRECT - Has design doc reference
{
  task_id: 'sprint-001-task-001',
  title: 'Implement AD001',
  ba_documents: {
    design_doc_id: 'DES-001',
    design_doc_path: 'Docs/design/DES-001.json',
    design_doc_status: 'approved'
  }
}
```

### 2. Document Status Flow
- `draft` ‚Üí `under_review` ‚Üí `approved` or `rejected`
- Only `approved` design docs can be used in Sprint Plans
- PM must review and approve before BA's work is used

### 3. VAS Compliance
- All design docs must comply with VAS (Vietnamese Accounting Standards)
- Accounting logic must be accurate (Debit = Credit)
- Legal requirements must be documented (e.g., Ngh·ªã ƒë·ªãnh 181/2024)

---

## üìö Usage Examples

### BA Creates Documents
```bash
node test-ba-v5-full.js
```

**Output**:
- `Docs/requirements/REQ-001.json`
- `Docs/design/DES-001.json`

### PM Reviews Documents
```javascript
const pm = new PMHelper();

// Get next document
const doc = await pm.getNextDocument();

// Approve
await pm.approveDocument('DES-001',
  'Excellent design! Clear logic, comprehensive tests.');

// Or reject
await pm.rejectDocument('DES-001',
  'Please add more test scenarios for edge cases.');
```

### PM Creates Sprint with Design Refs
```javascript
const pm = new PMHelper();

// Get approved designs
const designs = pm.getApprovedDesignsLocal();

// Create Sprint with design doc references
const sprint = pm.createSprintLocal({
  sprint_id: 'sprint-001',
  tasks: [
    {
      task_id: 'sprint-001-task-001',
      title: 'Implement AD001',
      ba_documents: {
        design_doc_id: 'DES-001',
        design_doc_path: 'Docs/design/DES-001.json',
        design_doc_status: 'approved'
      }
    }
  ]
});

// Validate
const validation = pm.validateSprintDesignReferences('sprint-001');
if (validation.valid) {
  pm.activateSprint('sprint-001');
}
```

### Dev Reads Design Doc
```javascript
const dev = new DevHelper();

// Get task
const task = dev.getMyActiveTasks()[0];

// Load design document
const designPath = path.join(process.cwd(), task.ba_documents.design_doc_path);
const designDoc = JSON.parse(fs.readFileSync(designPath, 'utf-8'));

// Read implementation specs
console.log('Accounting Logic:', designDoc.technical_design.accounting_logic);
console.log('Parameters:', designDoc.technical_design.parameters);
console.log('Test Scenarios:', designDoc.test_scenarios);
```

---

## üîÑ Complete Workflow Example

```
1. BA: Create REQ-001 (requirement document)
2. BA: Create DES-001 (design document, links to REQ-001)
3. BA: Submit DES-001 for PM review
4. PM: Review DES-001
5. PM: Approve DES-001
6. PM: Get approved designs
7. PM: Create Sprint-001 with task referencing DES-001
8. PM: Validate Sprint (checks design doc refs)
9. PM: Activate Sprint-001
10. PM: Assign task to Dev
11. Dev: Accept task
12. Dev: Read DES-001
13. Dev: Implement according to design
14. Dev: Submit for QA
```

---

## üìà Benefits

### For BA
- Structured document templates
- Clear workflow (draft ‚Üí review ‚Üí approve)
- Traceability (requirements ‚Üí design ‚Üí implementation)
- Version control via Git

### For PM
- Approved designs before Sprint planning
- Validation ensures tasks have design docs
- Review workflow with feedback
- Better planning with detailed specs

### For Dev
- Clear implementation specifications
- Accounting logic tables
- Code snippets and examples
- Test scenarios ready to use

### For Project
- Document-driven development
- Better quality through review process
- Compliance tracking (VAS, legal requirements)
- Audit trail (review history)

---

**Version**: 5.0
**Last Updated**: 2025-10-19
**Status**: Core infrastructure complete, orchestrator APIs pending
