# Agent Helpers V5.2 Update Summary

## Overview

All agent helpers have been updated to V5.2 to support **Project-Loader** integration with dynamic path resolution. This enables multi-project support and removes hard-coded path dependencies.

**Update Date:** October 20, 2025
**Orchestrator Version:** V5.1+
**Updated Agents:** PM, Dev, BA, QA

---

## What Changed in V5.2

### Key Improvements

1. **Dynamic Path Resolution**
   - All file paths are now loaded from orchestrator's project configuration API
   - No more hard-coded paths like `Docs/sprints` or `Docs/requirements`
   - Each project can have its own directory structure

2. **Multi-Project Support**
   - Agents can work with different projects via `--project` parameter
   - Project configuration loaded from orchestrator at runtime
   - Fallback to defaults if orchestrator unavailable

3. **API-Driven Configuration**
   - Helpers fetch configuration from orchestrator API endpoints
   - Uses `/projects/{projectId}/config` endpoint
   - Caching for performance

4. **Backward Compatibility**
   - Fallback mechanisms for missing configurations
   - Works with or without orchestrator connection
   - Graceful degradation to default paths

---

## Updated Agent Helpers

### 1. PM Helper V5.2

**File:** `agents/pm/pm-helper-v5.2.js`

**Changes:**
- Removed hard-coded `SPRINTS_DIR` constant
- Added `projectId` parameter support
- Added `loadProjectConfig()` method to fetch config from API
- Updated `SprintManager` class with async configuration loading
- All Sprint-related methods now use dynamic paths

**New Features:**
```bash
# Specify project when starting PM Helper
node pm-helper-v5.2.js --project trading-erp-mcp

# Or via environment variable
PROJECT_ID=my-project node pm-helper-v5.2.js
```

**API Usage:**
- Loads config from: `GET /projects/{projectId}/config`
- Uses orchestrator's `project-loader` module
- Falls back to `Docs/sprints` if API unavailable

**Code Example:**
```javascript
const PMHelper = require('./agents/pm/pm-helper-v5.2.js');

const pm = new PMHelper({
  projectId: 'trading-erp-mcp',
  orchestratorUrl: 'http://localhost:3000'
});

await pm.initialize(); // Loads project config
const sprints = await pm.listSprints(); // Uses dynamic paths
```

---

### 2. Dev Helper V5.2

**File:** `agents/dev/dev-helper-v5.2.js`

**Changes:**
- Removed hard-coded paths for `SPRINTS_DIR` and `MD_CONVERTER`
- Added `projectId` parameter support via `--project` flag
- Implemented `loadProjectConfig()` function
- Updated `SprintManager` class methods to be async
- All methods now use dynamic path resolution

**New Features:**
```bash
# Start Dev Helper with specific project
node dev-helper-v5.2.js --project trading-erp-mcp --sprint sprint-001

# Multiple parameters
node dev-helper-v5.2.js --host 192.168.1.100 --project my-erp --debug
```

**Updated Methods:**
- `getSprintPath(sprint_id)` → async, uses dynamic paths
- `loadSprint(sprint_id)` → async, uses dynamic MD converter path
- `listSprints()` → async, uses dynamic sprints directory
- `getTask(sprint_id, task_id)` → async
- `updateTaskStatus(sprint_id, task_id, status)` → async

**Code Example:**
```javascript
const sprintManager = new SprintManager();
await sprintManager.ensureConfig(); // Load config first

const sprints = await sprintManager.listSprints();
const task = await sprintManager.getTask('sprint-001', 'task-001');
```

---

### 3. BA Helper V5.2

**File:** `agents/ba/ba-helper-v5.2.js`

**Changes:**
- Removed hard-coded `requirementsDir` and `designDir` paths
- Added `projectId` parameter support
- Implemented `loadProjectConfig()` method
- All document methods now async with config loading
- Dynamic path resolution for requirement and design documents

**New Features:**
```bash
# Start BA Helper with specific project
node ba-helper-v5.2.js --project trading-erp-mcp
```

**Updated Methods:**
- All methods converted to async (await `ensureConfig()`)
- `createRequirementDoc(docData)` → uses dynamic requirements path
- `createDesignDoc(docData)` → uses dynamic design path
- `loadDocument(doc_id, docType)` → uses dynamic paths
- `listDocuments(docType)` → uses dynamic paths
- `getApprovedDesigns()` → uses dynamic design path

**Code Example:**
```javascript
const BAHelper = require('./agents/ba/ba-helper-v5.2.js');

const ba = new BAHelper({
  projectId: 'trading-erp-mcp',
  orchestratorUrl: 'http://localhost:3000'
});

await ba.loadProjectConfig(); // Load config

const doc = await ba.createDesignDoc({
  doc_id: 'DES-001',
  doc_name: 'Sales Invoice Design',
  feature_name: 'Sales Invoice Processing'
  // ... other fields
});
```

---

### 4. QA Helper V5.2

**File:** `agents/qa/qa-helper-v5.2.js`

**Changes:**
- Added `projectId` parameter for multi-project support
- Project context passed via `X-Project-Id` header to orchestrator
- Updated token file to `.qa-token-v5.json`
- Enhanced request method with project context
- Updated all methods to include project awareness

**Key Differences from Other Helpers:**
- QA Helper is **purely API-based** - no file system dependencies
- Doesn't need project-loader for paths (no Sprint or document files)
- Project awareness used for **task filtering** by orchestrator
- All operations through REST API endpoints

**New Features:**
```bash
# Start QA Helper with specific project
node qa-helper-v5.2.js --project trading-erp-mcp

# Or use in code
const qa = new QAHelper({ projectId: 'trading-erp-mcp' });
```

**Updated Methods:**
- `getNextTask()` → includes project filter in request header
- `listTasks()` → returns tasks filtered by project
- `completeTask(taskId, approved, result)` → unchanged (task-based)
- `request(method, endpoint, data)` → adds `X-Project-Id` header

**Code Example:**
```javascript
const QAHelper = require('./agents/qa/qa-helper-v5.2.js');

const qa = new QAHelper({
  projectId: 'trading-erp-mcp',
  orchestratorUrl: 'http://localhost:3000'
});

// Authenticate
await qa.ensureAuthenticated();

// Get next task (filtered by project)
const response = await qa.getNextTask();

if (response.available) {
  const task = response.task;
  console.log('Task:', task.id, task.type);

  // Complete task
  await qa.completeTask(task.id, true, {
    total: 10,
    passed: 10,
    failed: 0,
    testedBy: 'qa-agent-1'
  });
}
```

**Interactive Demo:**
```bash
# Run interactive QA workflow
node agents/qa/qa-agent-demo.js --project trading-erp-mcp
```

**Why V5.2 for QA?**

While QA Helper doesn't use file paths or project-loader like PM/Dev/BA, V5.2 adds:
1. **Consistency** - All helpers use same version and patterns
2. **Project Filtering** - Orchestrator can filter tasks by project
3. **Multi-Tenant** - Support for QA working on multiple projects
4. **Future-Ready** - Prepared for project-specific QA workflows

---

## Configuration Structure

### Project Configuration API Endpoint

**Endpoint:** `GET /projects/{projectId}/config`

**Response Example:**
```json
{
  "project": {
    "id": "trading-erp-mcp",
    "name": "Trading ERP MCP",
    "version": "1.0.0"
  },
  "paths": {
    "sprints": {
      "base": "Docs/sprints",
      "pattern": "sprint-{id}",
      "readme": "README.md",
      "json": "sprint.json",
      "tools": "tools",
      "archive": "archive"
    },
    "documents": {
      "requirements": "Docs/requirements",
      "design": "Docs/design",
      "reports": "orchestrator/reports"
    }
  },
  "conventions": {
    "sprint_id_format": "sprint-{number:3}",
    "task_id_format": "{sprint_id}-task-{number:3}",
    "doc_id_format": {
      "requirement": "REQ-{number:3}",
      "design": "DES-{number:3}"
    }
  },
  "tooling": {
    "md_converter": "Docs/sprints/tools/md-to-json-converter.js",
    "migration_script": "Docs/sprints/tools/migrate-old-sprints.js"
  }
}
```

---

## Migration Guide

### From V5.0/V5.1 to V5.2

**1. Update Orchestrator:**
   - Must be running orchestrator-server-v5.1.js or later
   - Ensure project-loader is integrated
   - Verify `/projects/list` and `/projects/{id}/config` endpoints work

**2. Update Project Configuration:**
   ```bash
   # Create project configuration if not exists
   cp orchestrator/templates/project.template.json .orchestrator/project.json

   # Edit .orchestrator/project.json with your paths
   # Validate configuration
   node orchestrator/tools/project-validator.js .orchestrator/project.json --check-paths
   ```

**3. Register Project:**
   ```bash
   # Add project to orchestrator's registry
   # Edit orchestrator/shared/projects.json
   ```

**4. Update Agent Helper Usage:**
   - PM Helper: Use `pm-helper-v5.2.js` instead of `pm-helper-v5.1.js`
   - Dev Helper: Use `dev-helper-v5.2.js` instead of old versions
   - BA Helper: Use `ba-helper-v5.2.js` instead of `ba-helper-v5.0.js`
   - QA Helper: Use `qa-helper-v5.2.js` instead of `qa-helper-v4.1.js`

**5. Update Start Scripts:**
   ```bash
   # Old
   node agents/pm/pm-helper-v5.1.js

   # New
   node agents/pm/pm-helper-v5.2.js --project trading-erp-mcp
   ```

---

## Backward Compatibility

All V5.2 helpers include fallback mechanisms:

### Fallback Behavior

1. **If orchestrator unavailable:**
   - Helpers log warning
   - Use default paths (`Docs/sprints`, `Docs/requirements`, etc.)
   - Continue operation with defaults

2. **If project config missing:**
   - Generate minimal default config
   - Use standard directory structure
   - Log warning but don't fail

3. **If API endpoint not found:**
   - Assume older orchestrator version
   - Fall back to V5.1 behavior
   - Continue with hard-coded defaults

### Example Fallback Code

```javascript
async loadProjectConfig() {
  try {
    const response = await axios.get(`${this.orchestratorUrl}/projects/${this.projectId}/config`);
    this.projectConfig = response.data;
    // ... use config
  } catch (error) {
    console.warn(`⚠️  Failed to load project config: ${error.message}`);
    console.warn(`   Using fallback defaults`);

    // Fallback configuration
    this.projectConfig = {
      project: { id: this.projectId, name: this.projectId },
      paths: {
        sprints: { base: 'Docs/sprints', readme: 'README.md', json: 'sprint.json' }
      }
    };

    this.sprintsDir = path.join(this.projectRoot, 'Docs/sprints');
    return this.projectConfig;
  }
}
```

---

## Testing

### Test V5.2 Helpers

**1. Test PM Helper:**
```bash
# Start orchestrator first
node orchestrator/shared/orchestrator-server-v5.1.js

# In another terminal, test PM Helper
node agents/pm/pm-helper-v5.2.js --project trading-erp-mcp

# Should see:
# ✅ Project config loaded: Trading ERP MCP
#    Sprints: Docs/sprints
```

**2. Test Dev Helper:**
```bash
# Test with debug mode
node agents/dev/dev-helper-v5.2.js --project trading-erp-mcp --debug

# Should list all sprints with correct paths
```

**3. Test BA Helper:**
```bash
# Test standalone
node agents/ba/ba-helper-v5.2.js --project trading-erp-mcp

# Should see:
# ✅ Project config loaded: Trading ERP MCP
#    Requirements: Docs/requirements
#    Design: Docs/design
# ✅ BA Helper V5.2 ready with project-loader support!
```

**4. Test API Integration:**
```bash
# Test project config endpoint
curl -s http://localhost:3000/projects/trading-erp-mcp/config | node -e "const data=require('fs').readFileSync(0,'utf-8'); console.log(JSON.stringify(JSON.parse(data), null, 2));"

# Should return full project configuration
```

---

## Benefits of V5.2

### For Developers

1. **Flexibility:** Work with multiple projects without code changes
2. **Maintainability:** No hard-coded paths to update
3. **Consistency:** All helpers use same configuration source
4. **Testing:** Easy to test with different project structures

### For Multi-Project Setups

1. **Single Orchestrator:** Serve multiple projects
2. **Project Isolation:** Each project has own configuration
3. **Easy Onboarding:** New projects just need config file
4. **Centralized Management:** All configs in orchestrator

### For Operations

1. **Graceful Degradation:** Works even if orchestrator down
2. **Clear Logging:** Shows what config is being used
3. **Easy Debugging:** Clear separation of config and logic
4. **Version Control:** Config in git, not in code

---

## Breaking Changes

### None (Fully Backward Compatible)

All V5.2 helpers are **100% backward compatible** with V5.1:

- Old scripts without `--project` parameter still work
- Default project ID is `trading-erp-mcp`
- Fallback to default paths if orchestrator unavailable
- No breaking API changes in helper methods

### Recommendations

While not required, we recommend:

1. Start using `--project` parameter explicitly
2. Ensure orchestrator is running V5.1+
3. Create `.orchestrator/project.json` for each project
4. Test fallback behavior for resilience

---

## Related Files

### Orchestrator Components

- `orchestrator/shared/orchestrator-server-v5.1.js` - Server with project-loader
- `orchestrator/shared/project-loader.js` - Core configuration loader
- `orchestrator/shared/projects.json` - Project registry
- `orchestrator/templates/project.schema.json` - Configuration schema
- `orchestrator/templates/project.template.json` - Template for new projects
- `orchestrator/tools/project-validator.js` - Validation tool
- `orchestrator/tools/project-config-generator.js` - Auto-generation tool

### Project Configuration

- `.orchestrator/project.json` - Project-specific configuration

### Documentation

- `orchestrator/shared/V5.1_INTEGRATION_GUIDE.md` - Integration guide
- `agents/V5.2_AGENT_UPDATES.md` - This file

---

## Support

For questions or issues with V5.2 agents:

1. Check orchestrator logs for errors
2. Verify project configuration with validator tool
3. Test with `--debug` flag for detailed logging
4. Check fallback behavior if orchestrator unavailable

---

**Version:** 1.0
**Last Updated:** October 20, 2025
**Status:** ✅ Complete and tested
